name: Dartotsu Unified Build & Release
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [main]
    tags: ["v*.*.*"]
  workflow_dispatch:
    inputs:
      build_targets:
        description: "Select platforms to build"
        required: true
        type: choice
        options: ["all", "android", "windows", "linux", "ios", "macos"]
      clean_build:
        description: "Clean build?"
        type: boolean
        default: false
      ping_discord:
        description: "Ping Discord role?"
        type: boolean
        default: false
      release_type:
        description: "Release type"
        type: choice
        options: ["alpha", "beta", "stable"]
        default: "alpha"

env:
  FLUTTER_VERSION: 3.35.7

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set_matrix.outputs.matrix }}
      release_type: ${{ steps.config.outputs.release_type }}
      is_alpha: ${{ steps.config.outputs.is_alpha }}
      is_beta: ${{ steps.config.outputs.is_beta }}
    steps:
      - name: Set release type
        id: config
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TYPE="${{ inputs.release_type }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            [[ "${{ github.ref_name }}" == *"beta"* ]] && TYPE="beta" || TYPE="stable"
          else
            TYPE="alpha"
          fi
          echo "release_type=$TYPE" >> $GITHUB_OUTPUT
          echo "is_alpha=$([[ $TYPE == 'alpha' ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "is_beta=$([[ $TYPE == 'beta' ]] && echo true || echo false)" >> $GITHUB_OUTPUT

      - name: Set build matrix
        id: set_matrix
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          MATRIX='{"include":['
          FIRST=true
          
          should_build() {
            local platform=$1
            if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
              case $platform in
                android) [[ "$COMMIT_MSG" == *"[build.apk]"* || "$COMMIT_MSG" == *"[build]"* || "$COMMIT_MSG" == *"[build.all]"* ]] && return 0 ;;
                windows) [[ "$COMMIT_MSG" == *"[build.windows]"* || "$COMMIT_MSG" == *"[build.all]"* ]] && return 0 ;;
                linux) [[ "$COMMIT_MSG" == *"[build.linux]"* || "$COMMIT_MSG" == *"[build.all]"* || "$COMMIT_MSG" == *"[build]"* ]] && return 0 ;;
                ios) [[ "$COMMIT_MSG" == *"[build.ios]"* || "$COMMIT_MSG" == *"[build.all]"* ]] && return 0 ;;
                macos) [[ "$COMMIT_MSG" == *"[build.macos]"* || "$COMMIT_MSG" == *"[build.all]"* ]] && return 0 ;;
              esac
            elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
              [[ "${{ inputs.build_targets }}" == "$platform" || "${{ inputs.build_targets }}" == "all" ]] && return 0
            elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
              return 0
            fi
            return 1
          }
          
          for platform in android:ubuntu-latest windows:windows-latest linux:ubuntu-latest ios:macos-latest macos:macos-latest; do
            IFS=':' read -r p os <<< "$platform"
            if should_build "$p"; then
              [[ "$FIRST" == false ]] && MATRIX+=','
              MATRIX+="{\"platform\":\"$p\",\"os\":\"$os\"}"
              FIRST=false
            fi
          done
          
          MATRIX+=']}'
          [[ "$FIRST" == true ]] && MATRIX='{"include":[]}'
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  build:
    needs: setup
    if: needs.setup.outputs.matrix != '{"include":[]}'
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        id: flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ${{ steps.flutter.outputs.pub-cache-path }}
            .dart_tool/
            build/
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/cmake
            ~/.cargo/**
            target/
          key: v2-${{ runner.os }}-${{ matrix.platform }}-${{ hashFiles('**/pubspec.lock','**/pubspec.yaml','**/*.gradle*','**/gradle-wrapper.properties','**/Cargo.lock') }}
          restore-keys: v2-${{ runner.os }}-${{ matrix.platform }}-

      - name: Setup Java (Android)
        if: matrix.platform == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup NDK (Android)
        if: matrix.platform == 'android'
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c

      - name: Setup Linux deps
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ninja-build cmake libgtk-3-dev webkit2gtk-4.1 libmpv-dev pkg-config fuse

      - name: Setup Windows dev env
        if: matrix.platform == 'windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Setup secrets
        shell: bash
        env:
          FLUTTER_VERSION_SECRET: ${{ secrets.FLUTTER_VERSION }}
          SIMKL_SECRET: ${{ secrets.SIMKL_SECRET }}
          APK_SIGN: ${{ secrets.APK_SIGN }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          PFX_FILE: ${{ secrets.PFX_FILE }}
        run: |
          echo "FLUTTER_VERSION=${FLUTTER_VERSION_SECRET:-$FLUTTER_VERSION}" >> $GITHUB_ENV
          echo "SIMKL_SECRET=$SIMKL_SECRET" > .env
          echo "hash=$(git rev-parse --short HEAD)" >> .env

          if [[ "${{ matrix.platform }}" == "android" ]]; then
            mkdir -p android/app
            echo "$APK_SIGN" | base64 --decode > android/app/dartotsu.jks
            cat > android/key.properties <<EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEYSTORE_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=dartotsu.jks
          EOF
          fi

          if [[ "${{ matrix.platform }}" == "windows" ]]; then
            mkdir -p "$HOME/certs"
            echo "$PFX_FILE" | base64 --decode > "$HOME/certs/Dartotsu.pfx"
          fi

      - name: Build
        shell: bash
        run: |
          ${{ inputs.clean_build && 'flutter clean && ' || '' }}flutter pub get

          case "${{ matrix.platform }}" in
            android)
              flutter build apk --release --split-per-abi
              flutter build apk --release
              cd build/app/outputs/flutter-apk
              for f in app-*-release.apk; do
                abi=$(echo $f | sed 's/app-\(.*\)-release.apk/\1/')
                mv $f Dartotsu_Android_${abi}_${{github.ref_name}}.apk
              done
              mv app-release.apk Dartotsu_Android_Universal_${{github.ref_name}}.apk
              ;;
            windows)
              version=$(grep 'version:' pubspec.yaml | sed 's/version: \([0-9.]*\).*/\1/')
              echo "version=$version" >> $GITHUB_ENV
              SIGNTOOL=$(powershell -Command "Get-ChildItem 'C:\Program Files (x86)\Windows Kits\10\bin' -Directory | Where-Object { \$_.Name -match '^\d+\.\d+\.\d+\.\d+$' } | Sort-Object Name -Descending | Select-Object -First 1 | ForEach-Object { Join-Path \$_.FullName 'x64\signtool.exe' }")
              dart run inno_bundle:build --sign-tool-params "\"$SIGNTOOL\" sign /fd sha256 /f \"$HOME/certs/Dartotsu.pfx\" /p \"${{secrets.PFX_PASSWORD}}\" /tr http://timestamp.digicert.com /td sha256 /v \$f" --release
              ;;
            linux)
              flutter build linux --release
              cd build/linux/x64/release/bundle
              zip -r Dartotsu_Linux_${{github.ref_name}}.zip .
              ;;
            ios)
              flutter build ios --release --no-codesign
              cd build/ios/iphoneos
              rm -rf Payload && mkdir -p Payload && cp -R Runner.app Payload/
              zip -r Dartotsu-iOS-${{ github.ref_name }}.ipa Payload
              ;;
            macos)
              flutter build macos --release
              mkdir -p build/macos/Release
              hdiutil create -volname "Dartotsu" -srcfolder build/macos/Build/Products/Release/Dartotsu.app -ov -format UDZO build/macos/Release/Dartotsu-macos-${{github.ref_name}}.dmg
              ;;
          esac

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-artifacts
          path: |
            build/app/outputs/flutter-apk/Dartotsu_Android_*.apk
            build/windows/x64/installer/Release/Dartotsu-x86_64-*-Installer.exe
            build/linux/x64/release/bundle/Dartotsu_Linux_*.zip
            build/ios/iphoneos/Dartotsu-iOS-*.ipa
            build/macos/Release/Dartotsu-macos-*.dmg

  drive_alpha:
    needs: [setup, build]
    if: needs.setup.outputs.is_alpha == 'true' && !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: "*-artifacts"

      - name: Upload to Google Drive
        run: |
          for file in artifacts/**/*.apk artifacts/**/*.exe artifacts/**/*.zip artifacts/**/*.ipa artifacts/**/*.dmg; do
            [[ -f "$file" ]] || continue
            filename=$(basename "$file")
            
            if [[ "$filename" == *"Android"* ]]; then
              folder="${{ secrets.GOOGLE_FOLDER_ANDROID }}"
              [[ "$filename" == *"Universal"* ]] && filename="Dartotsu.apk"
            else
              folder="${{ secrets.GOOGLE_FOLDER_MAIN }}"
            fi
            
            echo "Uploading $filename to folder $folder"
            curl -X POST https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart \
              -H "Authorization: Bearer $(echo '${{secrets.GOOGLE_KEY}}' | jq -r .private_key)" \
              -F "metadata={name:'$filename',parents:['$folder']};type=application/json" \
              -F "file=@$file"
          done

  release:
    needs: [setup, build]
    if: needs.setup.outputs.is_alpha == 'false' && !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: "*-artifacts"

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || git rev-list --max-parents=0 HEAD)
          REPO_URL="https://github.com/${{ github.repository }}"
          
          declare -A categories=(
            ["feat"]="### üéâ New Features"
            ["fix"]="### üõ†Ô∏è Bug Fixes & Improvements"
            ["refactor"]="### üîß Refactors"
            ["style"]="### üé® Style Changes"
            ["perf"]="### üöÄ Performance Improvements"
            ["chore"]="### üßπ Chores & Documentation"
          )
          
          declare -A commits
          while IFS= read -r line; do
            hash=$(echo "$line" | awk '{print $1}')
            msg=$(echo "$line" | cut -d' ' -f2-)
            type=$(echo "$msg" | grep -oP '^(feat|fix|refactor|style|perf|chore|docs|build|ci|bug|improvement|patch)' || echo "other")
            [[ "$type" =~ ^(bug|improvement|patch)$ ]] && type="fix"
            [[ "$type" =~ ^(docs|build|ci)$ ]] && type="chore"
            commits[$type]+="* [$hash]($REPO_URL/commit/$hash): $msg\n"
          done < <(git log $PREV_TAG..HEAD --pretty=format:'%h %s')
          
          echo "" > CHANGELOG.md
          for type in feat fix refactor style perf chore; do
            if [[ -n "${commits[$type]}" ]]; then
              echo "${categories[$type]}" >> CHANGELOG.md
              echo -e "${commits[$type]}" >> CHANGELOG.md
            fi
          done
          
          mkdir -p fastlane/metadata/android/en-US/changelogs
          awk '/^### üÜï Changelog/{flag=1; next}/^![Tt]otal/{flag=0}flag' CHANGELOG.md \
            | sed -E 's/!\[[^]]*\]\([^)]*\)//g; s/\[[^]]*\]\([^)]*\)//g; s/^÷ç[[:space:]]*/- /; /^$/N;/^\n$/D' \
            > fastlane/metadata/android/en-US/changelogs/default.txt

      - name: Create release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "artifacts/**/*"
          tag: ${{ github.ref_name }}
          bodyFile: CHANGELOG.md
          prerelease: ${{ needs.setup.outputs.is_beta == 'true' }}
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit changelog
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add CHANGELOG.md fastlane/metadata/android/en-US/changelogs/default.txt
          git commit -m "Update changelog for ${{ github.ref_name }}" || true
          git push origin HEAD:main || true
        continue-on-error: true

  notify_alpha:
    needs: [setup, build, drive_alpha]
    if: needs.setup.outputs.is_alpha == 'true' && !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get commits and contributors
        id: info
        run: |
          LAST_SHA_FILE=$(curl -s "https://api.github.com/repos/${{github.repository}}/actions/artifacts" \
            | jq -r '.artifacts[] | select(.name=="last-sha") | .archive_download_url' | head -1)
          
          if [[ -n "$LAST_SHA_FILE" ]]; then
            curl -L -H "Authorization: token ${{secrets.GITHUB_TOKEN}}" "$LAST_SHA_FILE" -o last-sha.zip
            unzip -p last-sha.zip > last_sha.txt || git rev-list --max-parents=0 HEAD > last_sha.txt
          else
            git rev-list --max-parents=0 HEAD > last_sha.txt
          fi
          
          LAST=$(cat last_sha.txt)
          COMMITS=$(git log $LAST..HEAD --pretty=format:"‚óè %s ~%an [÷ç](https://github.com/${{github.repository}}/commit/%H)" --max-count=10)
          
          declare -A commit_counts
          while read -r count name; do
            commit_counts["$name"]=$count
          done < <(echo "$COMMITS" | grep -oP '(?<=~)[^[]*' | sort | uniq -c | sort -rn)
          
          contributors=$(curl -s "https://api.github.com/repos/${{github.repository}}/contributors")
          developers=""
          max_commits=0
          avatar="https://i.imgur.com/qt1ixRk.gif"
          
          for login in $(echo "$contributors" | jq -r '.[].login' | head -10); do
            user=$(curl -s "https://api.github.com/users/$login")
            name=$(echo "$user" | jq -r '.name // .login')
            count=${commit_counts["$name"]:-0}
            [[ $count -eq 0 ]] && continue
            
            total=$(git log --author="$login" --oneline | wc -l)
            developers+="‚óó **$name**\n- Github: [$login](https://github.com/$login)\n- Commits: $total\n\n"
            
            if [[ $count -gt $max_commits ]]; then
              max_commits=$count
              avatar=$(echo "$user" | jq -r '.avatar_url')
            fi
          done
          
          echo "${{github.sha}}" > last_sha.txt
          
          COMMITS_ESCAPED=$(echo "$COMMITS" | sed 's/\\/\\\\/g; s/"/\\"/g')
          DEVS_ESCAPED=$(echo "${developers:0:1000}" | sed 's/\\/\\\\/g; s/"/\\"/g')
          
          echo "commits=$COMMITS_ESCAPED" >> $GITHUB_OUTPUT
          echo "developers=$DEVS_ESCAPED" >> $GITHUB_OUTPUT
          echo "avatar=$avatar" >> $GITHUB_OUTPUT

      - name: Send Discord notification
        run: |
          PING="${{ contains(github.event.head_commit.message, '[Ping]') || inputs.ping_discord && secrets.DISCORD_ALPHA_ROLE_PING || '' }}"
          
          curl -H "Content-Type: application/json" -d "$(jq -nc \
            --arg commits "${{ steps.info.outputs.commits }}" \
            --arg devs "${{ steps.info.outputs.developers }}" \
            --arg thumb "${{ steps.info.outputs.avatar }}" \
            --arg ping "$PING" \
            '{
              content: $ping,
              embeds: [{
                title: "New Alpha-Build dropped üî•",
                color: 1820869,
                fields: [
                  {name: "Commits:", value: $commits, inline: true},
                  {name: "Developers:", value: $devs, inline: false}
                ],
                footer: {text: "Alpha Build"},
                timestamp: (now|strftime("%Y-%m-%dT%H:%M:%S.000Z")),
                thumbnail: {url: $thumb}
              }]
            }')" \
            ${{ secrets.DISCORD_WEBHOOK_URL }}
          
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"[Download APK](https://drive.google.com/drive/folders/${{secrets.GOOGLE_FOLDER_ANDROID}})\"}" \
            ${{ secrets.DISCORD_WEBHOOK_URL }}

      - uses: actions/upload-artifact@v4
        with:
          name: last-sha
          path: last_sha.txt

  notify_release:
    needs: [setup, release]
    if: needs.setup.outputs.is_alpha == 'false' && !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    steps:
      - name: Install GitHub CLI
        run: |
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list
          sudo apt update && sudo apt install -y gh

      - name: Send Discord notification
        run: |
          echo "${{secrets.GITHUB_TOKEN}}" | gh auth login --with-token
          
          RELEASE=$(curl -s -H "Authorization: token ${{secrets.GITHUB_TOKEN}}" \
            "https://api.github.com/repos/${{github.repository}}/releases/latest")
          NOTES=$(echo "$RELEASE" | jq -r '.body')
          
          FORMATTED=$(echo "$NOTES" | grep -iE '^\*\s\[[a-f0-9]+\].*:(feat|fix|chore|bug)' | head -15 | sed -E 's/\): [^:]+:/) :/g')
          
          WEBHOOK="${{ needs.setup.outputs.is_beta == 'true' && secrets.DISCORD_WEBHOOK_BETA_URL || secrets.DISCORD_WEBHOOK_RELEASE_URL }}"
          PING="${{ needs.setup.outputs.is_beta == 'true' && secrets.DISCORD_BETA_ROLE_PING || secrets.DISCORD_STABLE_ROLE_PING }}"
          TITLE="${{ needs.setup.outputs.is_beta == 'true' && 'New Beta Release Dropped üöÄ' || 'New App Version Dropped üî•' }}"
          
          curl -H "Content-Type: application/json" -d "$(jq -nc \
            --arg title "$TITLE" \
            --arg desc "$FORMATTED\n\n[üìå Full changelog](https://github.com/${{github.repository}}/releases/tag/${{github.ref_name}})" \
            --arg ping "$PING" \
            --arg tag "${{github.ref_name}}" \
            '{
              content: $ping,
              embeds: [{
                title: $title,
                color: 1820869,
                description: $desc,
                footer: {text: ("Version "+$tag)},
                timestamp: (now|strftime("%Y-%m-%dT%H:%M:%S.000Z"))
              }]
            }')" \
            "$WEBHOOK"
          
          LINKS=$(gh release view --repo ${{github.repository}} ${{github.ref_name}} --json assets --jq '.assets[].url' | sort)
          
          MSG="**Dartotsu ${{github.ref_name}} Downloads:**\n\n"
          while read -r link; do
            [[ $link == *"arm64"* ]] && MSG+="‚Ä¢ [Android_arm64]($link)\n"
            [[ $link == *"armeabi"* ]] && MSG+="‚Ä¢ [Android_armeabi-v7a]($link)\n"
            [[ $link == *"x86_64"* ]] && [[ $link == *"Android"* ]] && MSG+="‚Ä¢ [Android_x86_64]($link)\n"
            [[ $link == *"Universal"* ]] && MSG+="‚Ä¢ [Android_Universal]($link)\n"
            [[ $link == *"iOS"* ]] && MSG+="‚Ä¢ [iOS]($link)\n"
            [[ $link == *"Linux"* ]] && MSG+="‚Ä¢ [Linux]($link)\n"
            [[ $link == *"macos"* ]] && MSG+="‚Ä¢ [macOS]($link)\n"
            [[ $link == *"Installer"* ]] && MSG+="‚Ä¢ [Windows]($link)\n"
          done <<< "$LINKS"
          
          curl -H "Content-Type: application/json" -d "{\"content\":\"$MSG\"}" "$WEBHOOK"

  trigger_downloader:
    needs: [setup, build, notify_alpha]
    if: needs.setup.outputs.is_alpha == 'true' && !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    steps:
      - name: Trigger downloader workflow
        run: |
          curl -X POST \
            -H "Authorization: token ${{secrets.DOWNLOADER_TRIGGER_TOKEN_SHEBY}}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/grayankit/Dartotsu-Downloader/actions/workflows/main.yml/dispatches \
            -d "{\"ref\":\"main\",\"inputs\":{\"commit_sha\":\"${{github.sha}}\",\"build_android\":\"success\",\"build_windows\":\"success\",\"build_linux\":\"success\",\"build_ios\":\"success\",\"build_macos\":\"success\"}}"
