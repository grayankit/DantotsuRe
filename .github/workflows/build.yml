name: Dartotsu Unified Build & Release
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [main]
    tags: ["v*.*.*"]
  workflow_dispatch:
    inputs:
      build_targets:
        description: "Select platforms to build"
        required: true
        type: choice
        options: ["all", "android", "windows", "linux", "ios", "macos"]
      clean_build:
        description: "Clean build?"
        type: boolean
        default: false
      ping_discord:
        description: "Ping Discord role?"
        type: boolean
        default: false
      release_type:
        description: "Release type"
        type: choice
        options: ["alpha", "beta", "stable"]
        default: "alpha"

env:
  FLUTTER_VERSION: 3.35.7

jobs:
  # ================================
  # 1. PREPARE - Determine build targets and release type
  # ================================
  prepare:
    runs-on: ubuntu-latest
    outputs:
      platforms: ${{ steps.set-platforms.outputs.platforms }}
      is_alpha: ${{ steps.config.outputs.is_alpha }}
      is_beta: ${{ steps.config.outputs.is_beta }}
      release_type: ${{ steps.config.outputs.release_type }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine release type
        id: config
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TYPE="${{ inputs.release_type }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            [[ "${{ github.ref_name }}" == *"beta"* ]] && TYPE="beta" || TYPE="stable"
          else
            TYPE="alpha"
          fi
          echo "release_type=$TYPE" >> $GITHUB_OUTPUT
          echo "is_alpha=$([[ $TYPE == 'alpha' ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "is_beta=$([[ $TYPE == 'beta' ]] && echo true || echo false)" >> $GITHUB_OUTPUT

      - name: Set platforms to build
        id: set-platforms
        run: |
          PLATFORMS='[]'
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TARGET="${{ inputs.build_targets }}"
            if [[ "$TARGET" == "all" ]]; then
              PLATFORMS='["android","windows","linux","ios","macos"]'
            elif [[ -n "$TARGET" ]]; then
              PLATFORMS="[\"$TARGET\"]"
            fi
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            PLATFORMS='["android","windows","linux","ios","macos"]'
          elif [[ "${{ github.event_name }}" == "push" ]] && [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            MESSAGE="${{ github.event.head_commit.message }}"
            if [[ "$MESSAGE" == *"[build.all]"* || "$MESSAGE" == *"[build]"* ]]; then
              PLATFORMS='["android","windows","linux","ios","macos"]'
            else
              TMP='['
              [[ "$MESSAGE" == *"[build.android]"* || "$MESSAGE" == *"[build.apk]"* ]] && TMP="${TMP}\"android\","
              [[ "$MESSAGE" == *"[build.windows]"* ]] && TMP="${TMP}\"windows\","
              [[ "$MESSAGE" == *"[build.linux]"* ]] && TMP="${TMP}\"linux\","
              [[ "$MESSAGE" == *"[build.ios]"* ]] && TMP="${TMP}\"ios\","
              [[ "$MESSAGE" == *"[build.macos]"* ]] && TMP="${TMP}\"macos\","
              PLATFORMS="${TMP%,}]"
            fi
          fi
          [[ "$PLATFORMS" == '[' ]] && PLATFORMS='[]'
          echo "platforms=$PLATFORMS" >> $GITHUB_OUTPUT
          echo "DEBUG: platforms = $PLATFORMS"

  # ================================
  # 2. BUILD - Matrix build for all platforms
  # ================================
  build:
    needs: prepare
    if: needs.prepare.outputs.platforms != '[]'
    strategy:
      fail-fast: false
      matrix:
        platform: ${{ fromJson(needs.prepare.outputs.platforms) }}
    runs-on: >-
      ${{ matrix.platform == 'windows' && 'windows-latest' ||
          (matrix.platform == 'ios' || matrix.platform == 'macos') && 'macos-latest' ||
          'ubuntu-latest' }}
    permissions:
      contents: write
    outputs:
      android_link: ${{ steps.android_upload.outputs.link }}
      windows_link: ${{ steps.windows_upload.outputs.link }}
      linux_link: ${{ steps.linux_upload.outputs.link }}
      ios_link: ${{ steps.ios_upload.outputs.link }}
      macos_link: ${{ steps.macos_upload.outputs.link }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - uses: actions/cache@v4
        with:
          path: |
            ${{ steps.flutter.outputs.pub-cache-path }}
            .dart_tool/
            build/
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/cmake
            ~/.cargo/**
            target/
          key: v2-${{ runner.os }}-${{ matrix.platform }}-${{ hashFiles('**/pubspec.lock','**/pubspec.yaml','**/*.gradle*','**/gradle-wrapper.properties','**/Cargo.lock') }}
          restore-keys: v2-${{ runner.os }}-${{ matrix.platform }}-

      - name: Setup Java (Android)
        if: matrix.platform == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup NDK (Android)
        if: matrix.platform == 'android'
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c

      - name: Setup cmake & ninja (Android)
        if: matrix.platform == 'android'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq ninja-build cmake
          mkdir -p /usr/local/lib/android/sdk/cmake/3.18.1/bin
          sudo ln -s /usr/bin/ninja /usr/local/lib/android/sdk/cmake/3.18.1/bin/ninja

      - name: Setup Linux deps
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq ninja-build cmake libgtk-3-dev webkit2gtk-4.1 libmpv-dev pkg-config fuse

      - name: Setup Windows dev env
        if: matrix.platform == 'windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Setup secrets (Non-Windows)
        if: matrix.platform != 'windows'
        env:
          FLUTTER_VERSION_SECRET: ${{ secrets.FLUTTER_VERSION }}
          SIMKL_SECRET: ${{ secrets.SIMKL_SECRET }}
          APK_SIGN: ${{ secrets.APK_SIGN }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          echo "FLUTTER_VERSION=${FLUTTER_VERSION_SECRET:-$FLUTTER_VERSION}" >> $GITHUB_ENV
          echo "SIMKL_SECRET=$SIMKL_SECRET" > .env
          echo "hash=$(git rev-parse --short HEAD)" >> .env
          if [[ "${{ matrix.platform }}" == "android" ]]; then
            mkdir -p android/app
            echo "$APK_SIGN" | base64 --decode > android/app/dartotsu.jks
            cat > android/key.properties <<EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEYSTORE_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=dartotsu.jks
          EOF
          fi

      - name: Setup secrets (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        env:
          FLUTTER_VERSION_SECRET: ${{ secrets.FLUTTER_VERSION }}
          SIMKL_SECRET: ${{ secrets.SIMKL_SECRET }}
          PFX_FILE: ${{ secrets.PFX_FILE }}
          PFX_PASSWORD: ${{ secrets.PFX_PASSWORD }}
        run: |
          $flutterVersion = if ($env:FLUTTER_VERSION_SECRET) { $env:FLUTTER_VERSION_SECRET } else { "${{ env.FLUTTER_VERSION }}" }
          echo "FLUTTER_VERSION=$flutterVersion" >> $env:GITHUB_ENV
          echo "SIMKL_SECRET=$env:SIMKL_SECRET" > .env
          $hash = git rev-parse --short HEAD
          echo "hash=$hash" >> .env
          mkdir -p $env:USERPROFILE\certs
          [System.IO.File]::WriteAllBytes("$env:USERPROFILE\certs\Dartotsu.pfx", [Convert]::FromBase64String($env:PFX_FILE))

      - name: Configure Gradle (Android)
        if: matrix.platform == 'android'
        run: |
          mkdir -p ~/.gradle
          echo "org.gradle.daemon=true" >> ~/.gradle/gradle.properties
          echo "org.gradle.parallel=true" >> ~/.gradle/gradle.properties
          echo "org.gradle.caching=true" >> ~/.gradle/gradle.properties

      - name: Build
        shell: bash
        run: |
          flutter pub get
          ${{ inputs.clean_build && 'flutter clean && ' || '' }}flutter pub get
          
          case "${{ matrix.platform }}" in
            android)
              flutter build apk --release --split-per-abi
              flutter build apk --release
              cd build/app/outputs/flutter-apk
              for f in app-*-release.apk; do
                abi=$(echo $f | sed 's/app-\(.*\)-release.apk/\1/')
                mv $f Dartotsu_Android_${abi}_${{ github.ref_name }}.apk
              done
              mv app-release.apk Dartotsu_Android_Universal_${{ github.ref_name }}.apk
              ;;
            windows)
              version=$(grep 'version:' pubspec.yaml | sed 's/version: \([0-9.]*\).*/\1/')
              echo "version=$version" >> $GITHUB_ENV
              dart run inno_bundle:build --sign-tool-params "signtool sign /fd sha256 /f \"C:\Users\runneradmin\certs\Dartotsu.pfx\" /p \"${{ secrets.PFX_PASSWORD }}\" /tr http://timestamp.digicert.com /td sha256 /v \$f" --release
              ;;
            linux)
              flutter build linux --release
              cd build/linux/x64/release/bundle
              zip -r Dartotsu_Linux_${{ github.ref_name }}.zip .
              ;;
            ios)
              flutter build ios --release --no-codesign
              cd build/ios/iphoneos
              rm -rf Payload && mkdir -p Payload && cp -R Runner.app Payload/
              zip -r Dartotsu-iOS-${{ github.ref_name }}.ipa Payload
              ;;
            macos)
              flutter build macos --release
              mkdir -p build/macos/Release
              hdiutil create -volname "Dartotsu" -srcfolder build/macos/Build/Products/Release/Dartotsu.app -ov -format UDZO build/macos/Release/Dartotsu-macos-${{ github.ref_name }}.dmg
              ;;
          esac

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-artifacts
          path: |
            ${{ matrix.platform == 'android' && 'build/app/outputs/flutter-apk/Dartotsu_Android_*.apk' || '' }}
            ${{ matrix.platform == 'windows' && 'build/windows/x64/installer/Release/Dartotsu-x86_64-*-Installer.exe' || '' }}
            ${{ matrix.platform == 'linux' && 'build/linux/x64/release/bundle/Dartotsu_Linux_*.zip' || '' }}
            ${{ matrix.platform == 'ios' && 'build/ios/iphoneos/Dartotsu-iOS-*.ipa' || '' }}
            ${{ matrix.platform == 'macos' && 'build/macos/Release/Dartotsu-macos-*.dmg' || '' }}

      # Store download links for later
      - name: Set output link (Android)
        if: matrix.platform == 'android'
        id: android_upload
        run: echo "link=https://drive.google.com/drive/folders/${{ secrets.GOOGLE_FOLDER_ANDROID }}" >> $GITHUB_OUTPUT

      - name: Set output link (Windows)
        if: matrix.platform == 'windows'
        id: windows_upload
        run: echo "link=https://drive.google.com/drive/folders/${{ secrets.GOOGLE_FOLDER_MAIN }}" >> $GITHUB_OUTPUT

      - name: Set output link (Linux)
        if: matrix.platform == 'linux'
        id: linux_upload
        run: echo "link=https://drive.google.com/drive/folders/${{ secrets.GOOGLE_FOLDER_MAIN }}" >> $GITHUB_OUTPUT

      - name: Set output link (iOS)
        if: matrix.platform == 'ios'
        id: ios_upload
        run: echo "link=https://drive.google.com/drive/folders/${{ secrets.GOOGLE_FOLDER_MAIN }}" >> $GITHUB_OUTPUT

      - name: Set output link (macOS)
        if: matrix.platform == 'macos'
        id: macos_upload
        run: echo "link=https://drive.google.com/drive/folders/${{ secrets.GOOGLE_FOLDER_MAIN }}" >> $GITHUB_OUTPUT

  # ================================
  # 3. ALPHA - Upload to Google Drive
  # ================================
  drive-alpha:
    needs: [prepare, build]
    if: needs.prepare.outputs.is_alpha == 'true' && !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Upload Android APKs to sub-folder
        if: contains(needs.prepare.outputs.platforms, 'android')
        uses: hoatruongdev09/google-drive-file-upload-github-action@v1.1
        with:
          file-path: artifacts/android-artifacts/Dartotsu_Android_*.apk
          upload-to-folder-id: ${{ secrets.GOOGLE_FOLDER_ANDROID }}
          service-account-json: "${{ secrets.GOOGLE_KEY }}"
          overwrite: true

      - name: Upload Windows installer to main folder
        if: contains(needs.prepare.outputs.platforms, 'windows')
        uses: hoatruongdev09/google-drive-file-upload-github-action@v1.1
        with:
          file-path: artifacts/windows-artifacts/Dartotsu-x86_64-*-Installer.exe
          upload-name: Dartotsu_windows.exe
          upload-to-folder-id: ${{ secrets.GOOGLE_FOLDER_MAIN }}
          service-account-json: "${{ secrets.GOOGLE_KEY }}"
          overwrite: true

      - name: Upload Linux zip to main folder
        if: contains(needs.prepare.outputs.platforms, 'linux')
        uses: hoatruongdev09/google-drive-file-upload-github-action@v1.1
        with:
          file-path: artifacts/linux-artifacts/Dartotsu_Linux_*.zip
          upload-name: Dartotsu_linux.zip
          upload-to-folder-id: ${{ secrets.GOOGLE_FOLDER_MAIN }}
          service-account-json: "${{ secrets.GOOGLE_KEY }}"
          overwrite: true

      - name: Upload iOS IPA to main folder
        if: contains(needs.prepare.outputs.platforms, 'ios')
        uses: hoatruongdev09/google-drive-file-upload-github-action@v1.1
        with:
          file-path: artifacts/ios-artifacts/Dartotsu-iOS-*.ipa
          upload-name: Dartotsu-iOS-${{ github.ref_name }}.ipa
          upload-to-folder-id: ${{ secrets.GOOGLE_FOLDER_MAIN }}
          service-account-json: "${{ secrets.GOOGLE_KEY }}"
          overwrite: true

      - name: Upload macOS DMG to main folder
        if: contains(needs.prepare.outputs.platforms, 'macos')
        uses: hoatruongdev09/google-drive-file-upload-github-action@v1.1
        with:
          file-path: artifacts/macos-artifacts/Dartotsu-macos-*.dmg
          upload-name: Dartotsu-macos-${{ github.ref_name }}.dmg
          upload-to-folder-id: ${{ secrets.GOOGLE_FOLDER_MAIN }}
          service-account-json: "${{ secrets.GOOGLE_KEY }}"
          overwrite: true

  # ================================
  # 4. BETA/STABLE - GitHub Release with Changelog
  # ================================
  release:
    needs: [prepare, build]
    if: needs.prepare.outputs.is_alpha == 'false' && !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      # Generate full changelog with mikepenz
      - name: Generate full changelog
        uses: mikepenz/release-changelog-builder-action@v4
        id: changelog
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          configurationJson: |
            {
              "categories": [
                {"title": "### üéâ New Features", "labels": ["feat"]},
                {"title": "### üõ†Ô∏è Bug Fixes & Improvements", "labels": ["fix"]},
                {"title": "### üîß Refactors", "labels": ["refactor"]},
                {"title": "### üé® Style Changes", "labels": ["style"]},
                {"title": "### üöÄ Performance Improvements", "labels": ["perf"]},
                {"title": "### üßπ Chores & Documentation", "labels": ["chore"]}
              ]
            }

      # Generate Fastlane changelog for IzzyOnDroid
      - name: Generate Fastlane changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || git rev-list --max-parents=0 HEAD)
          REPO_URL="https://github.com/${{ github.repository }}"
         
          declare -A categories=(
            ["feat"]="### üéâ New Features"
            ["fix"]="### üõ†Ô∏è Bug Fixes & Improvements"
            ["refactor"]="### üîß Refactors"
            ["style"]="### üé® Style Changes"
            ["perf"]="### üöÄ Performance Improvements"
            ["chore"]="### üßπ Chores & Documentation"
          )
         
          declare -A commits
          while IFS= read -r line; do
            hash=$(echo "$line" | awk '{print $1}')
            msg=$(echo "$line" | cut -d' ' -f2-)
            type=$(echo "$msg" | grep -oP '^(feat|fix|refactor|style|perf|chore|docs|build|ci)' || echo "other")
            [[ "$type" =~ ^(bug|improvement|patch)$ ]] && type="fix"
            [[ "$type" =~ ^(docs|build|ci)$ ]] && type="chore"
            commits[$type]+="* [$hash]($REPO_URL/commit/$hash): $msg\n"
          done < <(git log $PREV_TAG..HEAD --pretty=format:'%h %s')
         
          echo "" > CHANGELOG.md
          for type in feat fix refactor style perf chore; do
            if [[ -n "${commits[$type]}" ]]; then
              echo "${categories[$type]}" >> CHANGELOG.md
              echo -e "${commits[$type]}" >> CHANGELOG.md
            fi
          done
         
          mkdir -p fastlane/metadata/android/en-US/changelogs
          awk '/^### üéâ New Features/{flag=1; next}/^### üîß Refactors/{flag=0}flag' CHANGELOG.md \
            | sed -E 's/!\[[^]]*\]\([^)]*\)//g; s/\[[^]]*\]\([^)]*\)//g; s/^\*[[:space:]]+/-/; s/^\s+//; /^$/d' \
            > fastlane/metadata/android/en-US/changelogs/default.txt || true

      # Create/Update GitHub Release
      - name: Update GitHub Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "artifacts/**/*"
          tag: ${{ github.ref_name }}
          bodyFile: CHANGELOG.md
          prerelease: ${{ needs.prepare.outputs.is_beta == 'true' }}
          allowUpdates: true

      # Commit Fastlane changelog (non-blocking)
      - name: Commit Fastlane changelog
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add CHANGELOG.md fastlane/metadata/android/en-US/changelogs/default.txt
          git commit -m "chore: update changelog for ${{ github.ref_name }}" || echo "No changes"
          git push origin HEAD:main || echo "Push failed (non-critical)"
        continue-on-error: true

  # ================================
  # 5. ALPHA - Discord Notification (FULL ORIGINAL)
  # ================================
  notify-alpha:
    needs: [prepare, build, drive-alpha]
    if: needs.prepare.outputs.is_alpha == 'true' && !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    outputs:
      commit_logs: ${{ steps.set_output.outputs.commit_logs }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download last SHA artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: build.yml
          name: last-sha
        continue-on-error: true

      - name: Get Commits Since Last Run
        run: |
          if [ -f last_sha.txt ]; then
            LAST_SHA=$(cat last_sha.txt)
          else
            LAST_SHA=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "Commits since $LAST_SHA:"
          COMMIT_LOGS=$(git log $LAST_SHA..HEAD --pretty=format:"‚óè %s ~%an [÷ç](https://github.com/${{ github.repository }}/commit/%H)" --max-count=10)
          COMMIT_LOGS="${COMMIT_LOGS//'%'/'%25'}"
          COMMIT_LOGS="${COMMIT_LOGS//$'\n'/'%0A'}"
          COMMIT_LOGS="${COMMIT_LOGS//$'\r'/'%0D'}"
          echo "COMMIT_LOG=${COMMIT_LOGS}" >> $GITHUB_ENV
          echo "$COMMIT_LOGS"

      - name: Save Current SHA for Next Run
        run: echo ${{ github.sha }} > last_sha.txt

      - name: Set output
        id: set_output
        run: echo "commit_logs=${{ env.COMMIT_LOG }}" >> $GITHUB_OUTPUT

      - name: Check for Ping
        run: |
          if [[ "${{ github.event.head_commit.message }}" == *"[Ping]"* ]] || [[ "${{ inputs.ping_discord }}" == "true" ]]; then
            echo "ping_variable=<@&1324799528255225997>" >> $GITHUB_ENV
          else
            echo "ping_variable=" >> $GITHUB_ENV
          fi

      - name: Send Discord Notification with Rich Embeds
        shell: bash
        run: |
          fetch_user_details() {
            local login=$1
            user_details=$(curl -s "https://api.github.com/users/$login")
            name=$(echo "$user_details" | jq -r '.name // .login')
            login=$(echo "$user_details" | jq -r '.login')
            avatar_url=$(echo "$user_details" | jq -r '.avatar_url')
            echo "$name|$login|$avatar_url"
          }

          declare -A additional_info
          additional_info["ibo"]="\n Discord: <@951737931159187457>\n AniList: [takarealist112](<https://anilist.co/user/5790266/>)"
          additional_info["aayush262"]="\n Discord: <@918825160654598224>\n AniList: [aayush262](<https://anilist.co/user/5144645/>)"
          additional_info["Ankit Grai"]="\n Discord: <@1125628254330560623>\n AniList: [bheshnarayan](<https://anilist.co/user/6417303/>)\n X: [grayankit01](<https://x.com/grayankit01>)"

          declare -A contributor_colors
          default_color="#1ac4c5"
          contributor_colors["aayush262"]="#ff7eb6"
          contributor_colors["Sadwhy"]="#ff7e95"
          contributor_colors["grayankit"]="#c51aa1"
          contributor_colors["rebelonion"]="#d4e5ed"
          hex_to_decimal() { printf '%d' "0x${1#"#"}"; }

          declare -A recent_commit_counts
          echo "Debug: Processing COMMIT_LOG:"
          echo "$COMMIT_LOG"
          while read -r count name; do
              recent_commit_counts["$name"]=$count
              echo "Debug: Commit count for $name: $count"
          done < <(echo "$COMMIT_LOG" | sed 's/%0A/\n/g' | grep -oP '(?<=~)[^[]*' | sort | uniq -c | sort -rn)

          echo "Debug: Fetching contributors from GitHub"
          contributors=$(curl -L \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/${{github.repository}}/contributors)
          echo "Debug: Contributors response:"
          echo "$contributors"

          sorted_contributors=$(for login in $(echo "$contributors" | jq -r '.[].login'); do
              user_info=$(fetch_user_details "$login")
              name=$(echo "$user_info" | cut -d'|' -f1)
              count=${recent_commit_counts["$name"]:-0}
              echo "$count|$login"
          done | sort -rn | cut -d'|' -f2)

          developers=""
          committers_count=0
          max_commits=0
          top_contributor=""
          top_contributor_count=0
          top_contributor_avatar=""
          embed_color=$(hex_to_decimal "$default_color")

          while read -r login; do
            user_info=$(fetch_user_details "$login")
            name=$(echo "$user_info" | cut -d'|' -f1)
            login=$(echo "$user_info" | cut -d'|' -f2)
            avatar_url=$(echo "$user_info" | cut -d'|' -f3)

          commit_count=${recent_commit_counts["$name"]:-0}
          if [ $commit_count -gt 0 ]; then
            if [ $commit_count -gt $max_commits ]; then
              max_commits=$commit_count
              top_contributors=("$login")
              top_contributor_count=1
              top_contributor_avatar="$avatar_url"
              embed_color=$(hex_to_decimal "${contributor_colors[$name]:-$default_color}")
            elif [ $commit_count -eq $max_commits ]; then
              top_contributors+=("$login")
              top_contributor_count=$((top_contributor_count + 1))
              embed_color=$(hex_to_decimal "$default_color")
            fi

            branch_commit_count=$(git log --author="$login" --author="$name" --oneline | awk '!seen[$0]++' | wc -l)

            extra_info="${additional_info[$name]}"
            if [ -n "$extra_info" ]; then
              extra_info=$(echo "$extra_info" | sed 's/\\n/\n- /g')
            fi

            developer_entry="‚óó **${name}** ${extra_info}
          - Github: [${login}](https://github.com/${login})
          - Commits: ${branch_commit_count}"

            if [ -n "$developers" ]; then
              developers="${developers}
          ${developer_entry}"
            else
              developers="${developer_entry}"
            fi
            committers_count=$((committers_count + 1))
          fi
          done <<< "$sorted_contributors"

          if [ $top_contributor_count -eq 1 ]; then
            thumbnail_url="$top_contributor_avatar"
          else
            thumbnail_url="https://i.imgur.com/qt1ixRk.gif"
            embed_color=$(hex_to_decimal "$default_color")
          fi

          max_length=1000
          commit_messages=$(echo "$COMMIT_LOG" | sed 's/%0A/\n/g; s/^/\n/')
          if [ ${#developers} -gt $max_length ]; then
            developers="${developers:0:$max_length}... (truncated)"
          fi
          if [ ${#commit_messages} -gt $max_length ]; then
            commit_messages="${commit_messages:0:$max_length}... (truncated)"
          fi

          VERSION="${{ github.ref_name }}"
          discord_data=$(jq -nc \
                        --arg field_value "$commit_messages" \
                        --arg author_value "$developers" \
                        --arg footer_text "Version $VERSION" \
                        --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)" \
                        --arg thumbnail_url "$thumbnail_url" \
                        --arg embed_color "$embed_color" \
                        '{
                          "content": "${{env.ping_variable}}",
                          "embeds": [
                            {
                              "title": "New Alpha-Build dropped üî•",
                              "color": $embed_color,
                              "fields": [
                                {
                                  "name": "Commits:",
                                  "value": $field_value,
                                  "inline": true
                                },
                                {
                                  "name": "Developers:",
                                  "value": $author_value,
                                  "inline": false
                                }
                              ],
                              "footer": {
                                "text": $footer_text
                              },
                              "timestamp": $timestamp,
                              "thumbnail": {
                                "url": $thumbnail_url
                              }
                            }
                          ],
                          "attachments": []
                        }')
          echo "Debug: Final Discord payload:"
          echo "$discord_data"

          curl -H "Content-Type: application/json" \
              -d "$discord_data" \
              ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Upload Current SHA as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: last-sha
          path: last_sha.txt

      - name: Send Discord Notification with Download Links
        env:
          APK_DOWNLOAD_LINK: ${{ needs.build.outputs.android_link }}
          WINDOWS_DOWNLOAD_LINK: ${{ needs.build.outputs.windows_link }}
          LINUX_DOWNLOAD_LINK: ${{ needs.build.outputs.linux_link }}
          IOS_DOWNLOAD_LINK: ${{ needs.build.outputs.ios_link }}
          MACOS_DOWNLOAD_LINK: ${{ needs.build.outputs.macos_link }}
        run: |
          if [[ -n "$APK_DOWNLOAD_LINK" ]]; then
            APK_MESSAGE="[Download APK](https://drive.google.com/drive/folders/${{ secrets.GOOGLE_FOLDER_ANDROID }})"
          else
            APK_MESSAGE=""
          fi

          if [[ -n "$WINDOWS_DOWNLOAD_LINK" ]]; then
            WINDOWS_MESSAGE="[Download Windows Installer]($WINDOWS_DOWNLOAD_LINK)"
          else
            WINDOWS_MESSAGE=""
          fi

          if [[ -n "$LINUX_DOWNLOAD_LINK" ]]; then
            LINUX_MESSAGE="[Download Linux ZIP]($LINUX_DOWNLOAD_LINK)"
          else
            LINUX_MESSAGE=""
          fi

          if [[ -n "$IOS_DOWNLOAD_LINK" ]]; then
            IOS_MESSAGE="[Download iOS IPA]($IOS_DOWNLOAD_LINK)"
          else
            IOS_MESSAGE=""
          fi

          if [[ -n "$MACOS_DOWNLOAD_LINK" ]]; then
            MACOS_MESSAGE="[Download macOS DMG]($MACOS_DOWNLOAD_LINK)"
          else
            MACOS_MESSAGE=""
          fi

          curl -H "Content-Type: application/json" \
               -d "{\"content\": \"${APK_MESSAGE}\n${WINDOWS_MESSAGE}\n${LINUX_MESSAGE}\n${IOS_MESSAGE}\n${MACOS_MESSAGE}\"}" \
               "${{ secrets.DISCORD_WEBHOOK_URL }}"

  # ================================
  # 6. BETA/STABLE - Discord Release Notification
  # ================================
  notify-release:
    needs: [prepare, build, release]
    if: needs.prepare.outputs.is_alpha == 'false' && !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch Repository Tags by Date
        id: fetch_tags
        run: |
          curl -s "https://api.github.com/repos/${{github.repository}}/tags" -o tags.json
          TAGS=$(jq -r '.[].name' tags.json)
          declare -a TAGS_WITH_DATES=()
          for TAG in $TAGS; do
            TAG_DETAILS=$(curl -s "https://api.github.com/repos/${{github.repository}}/git/refs/tags/$TAG")
            OBJECT_URL=$(echo "$TAG_DETAILS" | jq -r '.object.url // empty')
            if [ -n "$OBJECT_URL" ]; then
              OBJECT_DETAILS=$(curl -s "$OBJECT_URL")
              DATE=$(echo "$OBJECT_DETAILS" | jq -r '.tagger.date // .committer.date // empty')
              if [ -n "$DATE" ]; then
                TAGS_WITH_DATES+=("$DATE $TAG")
              fi
            fi
          done
          LATEST_TAG=""
          LATEST_DATE=""
          for TAG_DATE in "${TAGS_WITH_DATES[@]}"; do
            TAG_DATE_TIME=$(echo "$TAG_DATE" | awk '{print $1}')
            TAG_NAME=$(echo "$TAG_DATE" | awk '{print $2}')
            if [[ -z "$LATEST_DATE" || "$TAG_DATE_TIME" > "$LATEST_DATE" ]]; then
              LATEST_DATE="$TAG_DATE_TIME"
              LATEST_TAG="$TAG_NAME"
            fi
          done
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV

      - name: Get Latest Release Notes
        id: get_release_notes
        run: |
          RELEASE_DATA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/releases/latest")

          RELEASE_NOTES=$(echo "$RELEASE_DATA" | jq -r '.body')
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
          echo "$RELEASE_NOTES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Format Release Notes for Discord
        id: format_notes
        run: |
          features=$(echo "$RELEASE_NOTES" | grep -iE '^\*\s\[[a-f0-9]+\]\(.*\):\sfeat' | head -n 5)
          if [[ -n "$features" ]]; then
            echo "**üöÄ Features**" > formatted_notes.txt
            echo "$features" >> formatted_notes.txt
            echo "" >> formatted_notes.txt
          fi
      
          fixes=$(echo "$RELEASE_NOTES" | grep -iE '^\*\s\[[a-f0-9]+\]\(.*\):\s(fix|bug|improvement|patch)' | head -n 5)
          if [[ -n "$fixes" ]]; then
            echo "**üêõ Fixes**" >> formatted_notes.txt
            echo "$fixes" >> formatted_notes.txt
            echo "" >> formatted_notes.txt
          fi

          chores=$(echo "$RELEASE_NOTES" | grep -iE '^\*\s\[[a-f0-9]+\]\(.*\):\s(chore|docs|build|ci)' | head -n 5)
          if [[ -n "$chores" ]]; then
            echo "**üõ† Chores**" >> formatted_notes.txt
            echo "$chores" >> formatted_notes.txt
            echo "" >> formatted_notes.txt
          fi

          FORMATTED_NOTES=$(cat formatted_notes.txt) 
          echo "FORMATTED_NOTES<<EOF" >> $GITHUB_ENV
          echo "$FORMATTED_NOTES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send Release Notification to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ needs.prepare.outputs.is_beta == 'true' && secrets.DISCORD_WEBHOOK_BETA_URL || secrets.DISCORD_WEBHOOK_RELEASE_URL }}
        run: |
          FORMATTED_NOTES=$(echo "$FORMATTED_NOTES" | sed -E 's/\): [^:]+:/) :/g')
          
          default_color="#1ac4c5"
          hex_to_decimal() { printf '%d' "0x${1#"#"}"; }
          embed_color=$(hex_to_decimal "$default_color")

          VERSION="${{ env.LATEST_TAG }}"
          RELEASE_TYPE="${{ needs.prepare.outputs.is_beta == 'true' && 'Beta' || 'Stable' }}"
          PING_ROLE="${{ needs.prepare.outputs.is_beta == 'true' && secrets.DISCORD_BETA_ROLE_PING || secrets.DISCORD_STABLE_ROLE_PING }}"

          discord_data=$(jq -nc \
                        --arg field_value "$FORMATTED_NOTES

[üìå Full changelog](https://github.com/${{github.repository}}/releases/tag/${{ env.LATEST_TAG }})" \
                        --arg footer_text "Version $VERSION" \
                        --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)" \
                        --argjson embed_color "$embed_color" \
                        --arg title "New $RELEASE_TYPE Release Dropped üî•" \
                        --arg ping "$PING_ROLE" \
                        '{
                          "content": $ping,
                          "embeds": [
                            {
                              "title": $title,
                              "color": $embed_color,
                              "description": $field_value,
                              "footer": {
                                "text": $footer_text
                              },
                              "timestamp": $timestamp
                            }
                          ]
                        }')

          curl -H "Content-Type: application/json" \
              -X POST \
              -d "$discord_data" \
              "$DISCORD_WEBHOOK_URL"

      - name: Send Download Links to Discord
        run: |
          sleep 3
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/latest" \
            | jq -r '.assets[].browser_download_url' \
            | sort > asset_links.txt

          MESSAGE="**Dartotsu ${{ env.LATEST_TAG }} Downloads:**\n\n"

          while IFS= read -r LINK; do
            if [[ $LINK == *"arm64"* ]]; then
              MESSAGE+="‚Ä¢ [Android_arm64]($LINK)\n"
            elif [[ $LINK == *"armeabi"* ]]; then
              MESSAGE+="‚Ä¢ [Android_armeabi-v7a]($LINK)\n"
            elif [[ $LINK == *"Android_x86"* ]]; then
              MESSAGE+="‚Ä¢ [Android_x86_64]($LINK)\n"
            elif [[ $LINK == *"Android_Universal"* ]]; then
              MESSAGE+="‚Ä¢ [Android_Universal]($LINK)\n"
            elif [[ $LINK == *"iOS"* ]]; then
              MESSAGE+="‚Ä¢ [iOS]($LINK)\n"
            elif [[ $LINK == *"Linux"* ]]; then
              MESSAGE+="‚Ä¢ [Linux]($LINK)\n"
            elif [[ $LINK == *"macos"* ]]; then
              MESSAGE+="‚Ä¢ [macOS]($LINK)\n"
            elif [[ $LINK == *"Installer"* ]]; then
              MESSAGE+="‚Ä¢ [Windows]($LINK)\n"
            fi
          done < asset_links.txt

          DISCORD_WEBHOOK_URL="${{ needs.prepare.outputs.is_beta == 'true' && secrets.DISCORD_WEBHOOK_BETA_URL || secrets.DISCORD_WEBHOOK_RELEASE_URL }}"
          
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\": \"$MESSAGE\"}" \
            "$DISCORD_WEBHOOK_URL"

  # ================================
  # 7. Trigger External Downloader (Alpha only)
  # ================================
  trigger-downloader:
    needs: [prepare, build, notify-alpha]
    if: >
      needs.prepare.outputs.is_alpha == 'true' &&
      !contains(needs.*.result, 'failure') &&
      github.repository == 'aayush2622/Dartotsu'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger downloader workflow
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.DOWNLOADER_TRIGGER_TOKEN_SHEBY }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/grayankit/Dartotsu-Downloader/actions/workflows/main.yml/dispatches \
            -d '{
              "ref":"main",
              "inputs":{
                "commit_sha":"${{ github.sha }}",
                "commit_logs":"${{ needs.notify-alpha.outputs.commit_logs }}",
                "build_android":"success",
                "build_windows":"success",
                "build_linux":"success",
                "build_ios":"success",
                "build_macos":"success"
              }
            }'