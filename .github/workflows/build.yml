name: Dartotsu Unified Build & Release
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [main]
    tags: ["v*.*.*"]
  workflow_dispatch:
    inputs:
      build_targets:
        description: "Select platforms to build"
        required: true
        type: choice
        options: ["all", "android", "windows", "linux", "ios", "macos"]
      clean_build:
        description: "Clean build?"
        type: boolean
        default: false
      ping_discord:
        description: "Ping Discord role?"
        type: boolean
        default: false
      release_type:
        description: "Release type"
        type: choice
        options: ["alpha", "beta", "stable"]
        default: "alpha"

env:
  FLUTTER_VERSION: 3.35.7

jobs:
  
  # 1. Determine release type & which platforms must be built
  prepare:
    runs-on: ubuntu-latest
    outputs:
      platforms: ${{ steps.set-platforms.outputs.platforms }}
      is_alpha: ${{ steps.config.outputs.is_alpha }}
      is_beta: ${{ steps.config.outputs.is_beta }}
      release_type: ${{ steps.config.outputs.release_type }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine release type
        id: config
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TYPE="${{ inputs.release_type }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            [[ "${{ github.ref_name }}" == *"beta"* ]] && TYPE="beta" || TYPE="stable"
          else
            TYPE="alpha"
          fi
          echo "release_type=$TYPE" >> $GITHUB_OUTPUT
          echo "is_alpha=$([[ $TYPE == 'alpha' ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "is_beta=$([[ $TYPE == 'beta' ]] && echo true || echo false)" >> $GITHUB_OUTPUT

      - name: Set platforms to build
        id: set-platforms
        run: |
          PLATFORMS='[]'

          # ---- Manual dispatch ----
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TARGET="${{ inputs.build_targets }}"
            if [[ "$TARGET" == "all" ]]; then
              PLATFORMS='["android","windows","linux","ios","macos"]'
            elif [[ -n "$TARGET" ]]; then
              PLATFORMS="[\"$TARGET\"]"
            fi

          # ---- Tag push ----
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            PLATFORMS='["android","windows","linux","ios","macos"]'

          # ---- Push to main ----
          elif [[ "${{ github.event_name }}" == "push" ]] && [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            MESSAGE="${{ github.event.head_commit.message }}"
            if [[ "$MESSAGE" == *"[build.all]"* ]]; then
              PLATFORMS='["android","windows","linux","ios","macos"]'
            else
              TMP='['
              [[ "$MESSAGE" == *"[build.android]"* ]] && TMP="${TMP}\"android\","
              [[ "$MESSAGE" == *"[build.windows]"* ]] && TMP="${TMP}\"windows\","
              [[ "$MESSAGE" == *"[build.linux]"* ]] && TMP="${TMP}\"linux\","
              [[ "$MESSAGE" == *"[build.ios]"* ]] && TMP="${TMP}\"ios\","
              [[ "$MESSAGE" == *"[build.macos]"* ]] && TMP="${TMP}\"macos\","
              PLATFORMS="${TMP%,}]"
            fi
          fi

          # Ensure we always output valid JSON (empty array if nothing selected)
          [[ "$PLATFORMS" == '[' ]] && PLATFORMS='[]'

          echo "platforms=$PLATFORMS" >> $GITHUB_OUTPUT
          echo "DEBUG: platforms JSON = $PLATFORMS"

  
  # 2. Build only the selected platforms
  build:
    needs: prepare
    if: needs.prepare.outputs.platforms != '[]'
    strategy:
      fail-fast: false
      matrix:
        platform: ${{ fromJson(needs.prepare.outputs.platforms) }}
    # OS is derived from the platform (no `include:`)
    runs-on: >-
      ${{ matrix.platform == 'windows' && 'windows-latest' ||
          (matrix.platform == 'ios' || matrix.platform == 'macos') && 'macos-latest' ||
          'ubuntu-latest' }}
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

        # Flutter 
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

        # Cache 
      - uses: actions/cache@v4
        with:
          path: |
            ${{ steps.flutter.outputs.pub-cache-path }}
            .dart_tool/
            build/
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/cmake
            ~/.cargo/**
            target/
          key: v2-${{ runner.os }}-${{ matrix.platform }}-${{ hashFiles('**/pubspec.lock','**/pubspec.yaml','**/*.gradle*','**/gradle-wrapper.properties','**/Cargo.lock') }}
          restore-keys: v2-${{ runner.os }}-${{ matrix.platform }}-

        # Android 
      - name: Setup Java
        if: matrix.platform == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup NDK
        if: matrix.platform == 'android'
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c

        # Linux 
      - name: Setup Linux deps
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq ninja-build cmake libgtk-3-dev webkit2gtk-4.1 libmpv-dev pkg-config fuse

        # Windows 
      - name: Setup Windows dev env
        if: matrix.platform == 'windows'
        uses: ilammy/msvc-dev-cmd@v1

        # Secrets (non‑Windows)
      - name: Setup secrets (Non‑Windows)
        if: matrix.platform != 'windows'
        env:
          FLUTTER_VERSION_SECRET: ${{ secrets.FLUTTER_VERSION }}
          SIMKL_SECRET: ${{ secrets.SIMKL_SECRET }}
          APK_SIGN: ${{ secrets.APK_SIGN }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          echo "FLUTTER_VERSION=${FLUTTER_VERSION_SECRET:-$FLUTTER_VERSION}" >> $GITHUB_ENV
          echo "SIMKL_SECRET=$SIMKL_SECRET" > .env
          echo "hash=$(git rev-parse --short HEAD)" >> .env

          if [[ "${{ matrix.platform }}" == "android" ]]; then
            mkdir -p android/app
            echo "$APK_SIGN" | base64 --decode > android/app/dartotsu.jks
            cat > android/key.properties <<EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEYSTORE_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=dartotsu.jks
          EOF
          fi

        # Secrets (Windows)
      - name: Setup secrets (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        env:
          FLUTTER_VERSION_SECRET: ${{ secrets.FLUTTER_VERSION }}
          SIMKL_SECRET: ${{ secrets.SIMKL_SECRET }}
          PFX_FILE: ${{ secrets.PFX_FILE }}
          PFX_PASSWORD: ${{ secrets.PFX_PASSWORD }}
        run: |
          $flutterVersion = if ($env:FLUTTER_VERSION_SECRET) { $env:FLUTTER_VERSION_SECRET } else { "${{ env.FLUTTER_VERSION }}" }
          echo "FLUTTER_VERSION=$flutterVersion" >> $env:GITHUB_ENV
          echo "SIMKL_SECRET=$env:SIMKL_SECRET" > .env
          $hash = git rev-parse --short HEAD
          echo "hash=$hash" >> .env
          
          mkdir -p $env:USERPROFILE\certs
          [System.IO.File]::WriteAllBytes("$env:USERPROFILE\certs\Dartotsu.pfx", [Convert]::FromBase64String($env:PFX_FILE))

        # Build 
      - name: Build
        shell: bash
        run: |
          flutter pub get
          ${{ inputs.clean_build && 'flutter clean && ' || '' }}flutter pub get

          case "${{ matrix.platform }}" in
            android)
              flutter build apk --release --split-per-abi
              flutter build apk --release
              cd build/app/outputs/flutter-apk
              for f in app-*-release.apk; do
                abi=$(echo $f | sed 's/app-\(.*\)-release.apk/\1/')
                mv $f Dartotsu_Android_${abi}_${{ github.ref_name }}.apk
              done
              mv app-release.apk Dartotsu_Android_Universal_${{ github.ref_name }}.apk
              ;;
            windows)
              version=$(grep 'version:' pubspec.yaml | sed 's/version: \([0-9.]*\).*/\1/')
              echo "version=$version" >> $GITHUB_ENV
              dart run inno_bundle:build --sign-tool-params "signtool sign /fd sha256 /f \"C:\Users\runneradmin\certs\Dartotsu.pfx\" /p \"${{ secrets.PFX_PASSWORD }}\" /tr http://timestamp.digicert.com /td sha256 /v \$f" --release
              ;;
            linux)
              flutter build linux --release
              cd build/linux/x64/release/bundle
              zip -r Dartotsu_Linux_${{ github.ref_name }}.zip .
              ;;
            ios)
              flutter build ios --release --no-codesign
              cd build/ios/iphoneos
              rm -rf Payload && mkdir -p Payload && cp -R Runner.app Payload/
              zip -r Dartotsu-iOS-${{ github.ref_name }}.ipa Payload
              ;;
            macos)
              flutter build macos --release
              mkdir -p build/macos/Release
              hdiutil create -volname "Dartotsu" -srcfolder build/macos/Build/Products/Release/Dartotsu.app -ov -format UDZO build/macos/Release/Dartotsu-macos-${{ github.ref_name }}.dmg
              ;;
          esac

        # Upload artifacts
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-artifacts
          path: |
            ${{ matrix.platform == 'android' && 'build/app/outputs/flutter-apk/Dartotsu_Android_*.apk' || '' }}
            ${{ matrix.platform == 'windows' && 'build/windows/x64/installer/Release/Dartotsu-x86_64-*-Installer.exe' || '' }}
            ${{ matrix.platform == 'linux' && 'build/linux/x64/release/bundle/Dartotsu_Linux_*.zip' || '' }}
            ${{ matrix.platform == 'ios' && 'build/ios/iphoneos/Dartotsu-iOS-*.ipa' || '' }}
            ${{ matrix.platform == 'macos' && 'build/macos/Release/Dartotsu-macos-*.dmg' || '' }}
  
  # 3. Alpha – upload APKs to Google Drive
  drive-alpha:
    needs: [prepare, build]
    if: needs.prepare.outputs.is_alpha == 'true' && !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - uses: adityaa1999/google-drive-upload-git-action@v3
        with:
          credentials: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
          folderId: ${{ secrets.GOOGLE_FOLDER_ANDROID }}
          filename: "artifacts/android-artifacts/**/*.apk"
          overwrite: true
 
  # 4. Beta / Stable – create GitHub release
  release:
    needs: [prepare, build]
    if: needs.prepare.outputs.is_alpha == 'false' && !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Generate changelog
        uses: mikepenz/release-changelog-builder-action@v4
        id: changelog
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          configurationJson: |
            {
              "categories": [
                {"title": "### New Features", "labels": ["feat"]},
                {"title": "### Bug Fixes & Improvements", "labels": ["fix"]},
                {"title": "### Refactors", "labels": ["refactor"]},
                {"title": "### Style Changes", "labels": ["style"]},
                {"title": "### Performance Improvements", "labels": ["perf"]},
                {"title": "### Chores & Documentation", "labels": ["chore"]}
              ]
            }
      - uses: ncipollo/release-action@v1
        with:
          artifacts: "artifacts/**/*"
          tag: ${{ github.ref_name }}
          body: ${{ steps.changelog.outputs.changelog }}
          prerelease: ${{ needs.prepare.outputs.is_beta == 'true' }}
          allowUpdates: true
  
  # 5. Alpha – Discord notification
  notify-alpha:
    needs: [prepare, build, drive-alpha]
    if: needs.prepare.outputs.is_alpha == 'true' && !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get recent commits
        id: commits
        run: |
          LAST=$(git rev-list --max-parents=0 HEAD || echo "")
          COMMITS=$(git log $LAST..HEAD --pretty=format:"• %s (%an)" --max-count=8 | paste -sd '\n' -)
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - uses: tsickert/discord-webhook@v5
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          content: ${{ inputs.ping_discord && secrets.DISCORD_ALPHA_ROLE_PING || '' }}
          embed-title: "New Alpha Build Dropped"
          embed-description: |
            **Commits**
            ${{ steps.commits.outputs.commits }}
            **Download**
            [Google Drive Folder](https://drive.google.com/drive/folders/${{ secrets.GOOGLE_FOLDER_ANDROID }})
          embed-color: 1820869
          embed-footer: "Alpha Build • ${{ github.sha }}"
      - uses: actions/upload-artifact@v4
        with:
          name: last-sha
          path: .git/HEAD
  
  # 6. Beta / Stable – Discord notification
  notify-release:
    needs: [prepare, build, release]
    if: needs.prepare.outputs.is_alpha == 'false' && !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    steps:
      - name: Get release URL
        id: rel
        run: |
          URL="${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
          echo "url=$URL" >> $GITHUB_OUTPUT
      - uses: tsickert/discord-webhook@v5
        with:
          webhook-url: ${{ needs.prepare.outputs.is_beta == 'true' && secrets.DISCORD_WEBHOOK_BETA_URL || secrets.DISCORD_WEBHOOK_RELEASE_URL }}
          content: ${{ needs.prepare.outputs.is_beta == 'true' && secrets.DISCORD_BETA_ROLE_PING || secrets.DISCORD_STABLE_ROLE_PING }}
          embed-title: "New ${{ needs.prepare.outputs.is_beta == 'true' && 'Beta' || 'Stable' }} Release"
          embed-description: |
            [View Release](${{ steps.rel.outputs.url }})
          embed-color: 1820869
  
  # 7. Trigger external downloader (alpha only)
  trigger-downloader:
    needs: [prepare, build, notify-alpha]
    if: needs.prepare.outputs.is_alpha == 'true' && !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    steps:
      - name: Trigger downloader
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.DOWNLOADER_TRIGGER_TOKEN_SHEBY }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/grayankit/Dartotsu-Downloader/actions/workflows/main.yml/dispatches \
            -d '{
              "ref":"main",
              "inputs":{
                "commit_sha":"${{ github.sha }}",
                "build_android":"success",
                "build_windows":"success",
                "build_linux":"success",
                "build_ios":"success",
                "build_macos":"success"
              }
            }'
